# 架构设计

## 系统概述

GhostTap 是一个端云协同的 Android 远程控制系统，核心设计理念是：

> **手机端是"无脑"的传感器+执行器，所有智能逻辑在云端**

## 核心原则

- **端云分离**：手机只采集和执行，AI 决策在云端
- **AI-Native**：不做规则引擎，完全由 AI 理解界面并决策
- **协议简洁**：最小化消息类型，减少状态流转
- **隐私优先**：敏感操作自动暂停，用户全程可控

## 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      用户交互层                          │
│              OpenClaw / Feishu / 任意 IM                │
└──────────────────────────┬──────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────┐
│                      云端层                              │
│  ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │  WebSocket      │◄──►│  AI Core (LLM)              │ │
│  │  Gateway        │    │  - 理解 UI 状态             │ │
│  │                 │    │  - 决策下一步动作           │ │
│  └────────┬────────┘    └─────────────────────────────┘ │
│           │                                             │
│           │  UI Formatter (JSON → 文本)                 │
│           │                                             │
└───────────┼─────────────────────────────────────────────┘
            │ WebSocket (wss://)
┌───────────┼─────────────────────────────────────────────┐
│           │                  手机端                       │
│  ┌────────▼────────┐                                     │
│  │  WebSocket      │                                     │
│  │  Client         │                                     │
│  └────────┬────────┘                                     │
│           │                                              │
│  ┌────────▼────────┐    ┌─────────────────┐              │
│  │  Event Reporter │───►│ Accessibility   │              │
│  │  (采集 UI)       │    │ Service         │              │
│  └─────────────────┘    └─────────────────┘              │
│                                              ┌──────────┐│
│  ┌─────────────────┐    ┌─────────────────┐  │ System   ││
│  │  Action Executor│◄───│  Command Parser │  │ APIs     ││
│  │  (执行动作)      │    │  (解析指令)      │◄─┘          ││
│  └─────────────────┘    └─────────────────┘              ││
│                                                           ││
│  ┌─────────────────────────────────────────┐              ││
│  │  Floating Window (悬浮窗)               │              ││
│  │  - 显示任务状态                          │              ││
│  │  - 用户授权/暂停/结束                    │              ││
│  └─────────────────────────────────────────┘              ││
└───────────────────────────────────────────────────────────┘
```

## 数据流

### 上行：手机 → 云端

```
无障碍事件触发
    │
    ▼
采集 UI 树
    │
    ▼
预过滤（只保留可交互元素，20-30个）
    │
    ▼
百分比坐标转换
    │
    ▼
JSON → WebSocket → 云端
    │
    ▼
UI Formatter 转文本 → AI 理解
```

### 下行：云端 → 手机

```
AI 决策动作
    │
    ▼
生成指令（百分比坐标）
    │
    ▼
WebSocket → 手机
    │
    ▼
百分比转绝对坐标
    │
    ▼
无障碍执行
    │
    ▼
UI 变化自动触发新上报
```

## 模块职责

### 手机端 (Android)

| 模块 | 职责 | 技术要点 |
|------|------|---------|
| ConnectionManager | WebSocket 连接、心跳、重连 | OkHttp, 3分钟心跳 |
| AccessibilityCollector | 监听事件、采集 UI | AccessibilityService |
| UI Pre-filter | 过滤不可交互元素 | 保留 clickable/focusable |
| CommandExecutor | 执行云端指令 | 无障碍 Action API |
| FloatWindowManager | 悬浮窗管理 | WindowManager |
| AuthorizationHandler | 用户授权处理 | UI 交互 |

### 云端 (Server)

| 模块 | 职责 | 技术要点 |
|------|------|---------|
| WebSocket Gateway | 连接管理、消息路由 | ws library |
| Session Manager | 会话状态管理 | In-Memory (MVP) |
| UI Formatter | JSON → 自然语言 | 模板转换 |
| AI Core | LLM 调用、决策 | OpenAI/Claude API |
| Message Bridge | 对接 IM 平台 | OpenClaw Adapter |

## 通信协议

### 连接

- **协议**: WebSocket over TLS (wss://)
- **传输层**: TCP
- **心跳**: 3分钟间隔，手机主动发送 ping
- **重连**: 指数退避 (1s → 2s → 4s → ... → 60s)

### 消息类型

| 方向 | 消息 | 说明 |
|------|------|------|
| ↑ | ping | 心跳，每3分钟 |
| ↓ | pong | 心跳响应 |
| ↑ | ui_event | UI 变化上报 |
| ↓ | request_control | 请求控制 |
| ↑ | authorization | 用户授权响应 |
| ↓ | action | 执行指令 |
| ↑ | resume | 用户恢复任务 |
| ↓ | task_end | 任务结束 |

详见 [protocol.md](protocol.md)

## 安全设计

### 通信安全

- TLS 1.2/1.3 加密传输
- 简单 user_id 认证（MVP）
- session_id 绑定单次任务

### 隐私保护

- UI 数据仅实时决策，不持久化
- 敏感操作（支付/密码）自动暂停
- 开源可审计

### 人工接管

- 每次任务需用户授权
- 悬浮窗始终显示任务状态
- 一键结束任务

## 部署

### MVP 架构

```
Single Server
├── WebSocket Gateway (Node.js)
├── Session Store (In-Memory)
└── AI Client (OpenAI API)
```

### 扩展架构

```
Load Balancer
    ├── WS Node 1
    ├── WS Node 2
    └── ...
        │
        └── Redis (Session Store)
```

## 迭代路线

### Phase 1: MVP (1-2周)
- [x] 基础 WebSocket 通信
- [x] 手机端 UI 预过滤
- [x] 云端格式转换
- [x] 基础 AI 决策
- [x] 简化悬浮窗

### Phase 2: 优化 (2-3周)
- [ ] 截图辅助决策
- [ ] 批量动作序列
- [ ] 任务历史记录

### Phase 3: 生态 (持续)
- [ ] 多设备支持
- [ ] 任务市场
- [ ] 社区贡献

## Token 消耗监控

### 消耗估算

| 部分 | Token 数 | 说明 |
|------|---------|------|
| System Prompt | ~500 | 固定指令 |
| UI 状态 | ~800 | 20-30个元素 |
| 用户目标 | ~20 | 任务描述 |
| **单次 Input** | **~1300** | |
| **单次 Output** | **~150-200** | JSON决策 |
| **单次成本** | **~$0.003-0.005** | GPT-4o-mini |

| 任务类型 | 步骤数 | 成本 |
|---------|-------|------|
| 简单（打开APP点击） | 3-5步 | ~$0.02 |
| 中等（登录+操作） | 8-12步 | ~$0.05 |
| 复杂（完整流程） | 15-25步 | ~$0.10-0.15 |

### 监控方案

**云端追踪**:
```typescript
interface TaskMetrics {
  task_id: string;
  steps: number;
  total_tokens: number;
  input_tokens: number;
  output_tokens: number;
  cost_usd: number;
  model: string;
  start_time: number;
  end_time: number;
}
```

**消息下发**（实时同步到手机）:
```json
{
  "type": "task_metrics",
  "session_id": "xxx",
  "current_step": 5,
  "current_cost": 0.03,
  "total_tokens": 7500
}
```

### 展示方案

**悬浮窗**（当前任务实时）:
```
┌────────────────────────┐
│ 🤖 淘宝签到中... 💰 ¥0.03│
│ [暂停]  [结束]         │
└────────────────────────┘
```

**设置页**（累计统计）:
```
┌─────────────────────────────┐
│      Token 消耗统计         │
├─────────────────────────────┤
│  本月累计      ¥12.50       │
│  今日调用      45次         │
│  今日消耗      ¥0.85        │
│  平均每次      ¥0.02        │
│                             │
│  当前任务      ¥0.03 (5步)  │
│                             │
│  [查看详细记录]             │
└─────────────────────────────┘
```

### 成本控制

| 策略 | 效果 |
|-----|------|
| UI预过滤 | 节省80% tokens |
| 300ms防抖 | 避免重复调用 |
| GPT-4o-mini | 比GPT-4o便宜90% |
| 批量动作 | 减少API调用次数 |
